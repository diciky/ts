<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>推送设置</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start; /* 顶部对齐 */
      min-height: 10vh;
      padding-top: env(safe-area-inset-top, 20px); /* 安全区内边距 */
      background: url('back.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      overflow-y: auto;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('back.jpg') no-repeat center center;
      background-size: cover;
      z-index: -1;
    }
    .password-container,
    .container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 90%;
      max-width: 600px;
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .password-container {
      align-items: center;
      text-align: center;
    }
    .container {
      display: none;
      position: relative;
      margin-top: 10px;
      background: rgba(255, 255, 255, 0.1);
    }
    .confirm-btn {
      padding: 8px 16px;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: opacity 0.3s;
    }
    .confirm-btn:hover {
      opacity: 0.9;
    }
    .confirm-btn.disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    /* 开关整体外层盒子 */
    .switch-box {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 5px;
    }
    .switch-item {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 5px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      background: rgba(255, 255, 255, 0.6);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .switch-item .label {
      font-size: 0.8rem;
      color: #333;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }
    .toggle-switch {
  position: relative;
  width: 44px; /* 55px * 0.8 */
  height: 25.6px; /* 32px * 0.8 */
  border-radius: 26.4px; /* 33px * 0.8 */
  background-color: #ccc;
  cursor: pointer;
  transition: background-color 0.3s;
}
.toggle-switch::before {
  content: '';
  position: absolute;
  top: 1.6px;  /* 2px * 0.8 */
  left: 1.6px; /* 2px * 0.8 */
  width: 22.4px; /* 28px * 0.8 */
  height: 22.4px; /* 28px * 0.8 */
  border-radius: 50%;
  background-color: white;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
  transition: transform 0.3s ease;
}
.toggle-switch.on {
  background-color: #34c759;
}
.toggle-switch.on::before {
  transform: translateX(17.6px); /* 22px * 0.8 */
}

.material-checkbox {
  display: flex;
  align-items: center;
  font-size: 12px;
  color: #000000;
  cursor: pointer;
  user-select: none;
}

.material-checkbox input[type="checkbox"] {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}

.checkmark {
  position: relative;
  display: inline-block;
  width: 16px; /* 原 20px * 0.8 */
  height: 16px; /* 原 20px * 0.8 */
  margin-right: 5px; /* 原 1px，可改为 0.8px */
  border: 1.6px solid #454B00; /* 原 2px * 0.8 */
  border-radius: 4px;
  transition: all 0.3s;
}

.material-checkbox input[type="checkbox"]:checked ~ .checkmark {
  background-color: #2F3300;
}

.material-checkbox input[type="checkbox"]:checked ~ .checkmark:after {
  content: "";
  position: absolute;
  top: 1.6px; /* 原 2px * 0.8 */
  left: 4.8px; /* 原 6px * 0.8 */
  width: 3.2px; /* 原 4px * 0.8 */
  height: 8px; /* 原 10px * 0.8 */
  border: solid white;
  border-width: 0 1.6px 1.6px 0; /* 原 2px * 0.8 */
  transform: rotate(45deg);
}

.material-checkbox input[type="checkbox"]:focus ~ .checkmark {
  box-shadow: 0 0 0 2px #dfec5065;
}

.material-checkbox:hover input[type="checkbox"]:not(:checked) ~ .checkmark {
  border-color: #C3CF34;
}

.material-checkbox input[type="checkbox"]:disabled ~ .checkmark {
  opacity: 0.5;
  cursor: not-allowed;
}

.material-checkbox input[type="checkbox"]:disabled:hover ~ .checkmark {
  border-color: #4d4d4d;
}

/* ... 其他样式保持不变 ... */
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 5px;
      justify-content: center;
    }
    .action-buttons button {
      padding: 10px 20px;
      font-size: 0.8rem;
      background-color: #007aff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      flex: 0 0 calc(50% - 15px);
    }
    .action-buttons button:hover {
      background-color: #0056d2;
    }
    .valueDisplay {
      font-size: 0.8rem;
      margin-bottom: 0px;
    }
    #error-message {
      color: red;
      display: none;
    }
    #toast {
      position: fixed;
      bottom: -50px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 9999;
    }
    #toast.show {
      bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="password-container" id="password-container">
    <label for="password">系统登录</label>
    <input type="password" id="password" placeholder="请输入管理密码" />
    <button class="confirm-btn" onclick="verifyPassword()">登录</button>
    <p id="error-message">密码错误，请重新输入。</p>
  </div>

  <div class="container" id="main-content">
    <!-- 动态加载内容 -->
  </div>
  <div id="toast"></div>

  <script>
    let authToken = null;

    function showToast(message, duration = 2000) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
      }, duration);
    }

    function setCookie(name, value, days = 36500) {
      const date = new Date();
      date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
      const expires = "; expires=" + date.toUTCString();
      document.cookie = name + "=" + (value || "") + expires + "; path=/;";
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(";");
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    function deleteCookie(name) {
      document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    }

    function logout() {
      deleteCookie("authToken");
      location.reload();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const token = getCookie("authToken");
      if (token) {
        authToken = `Bearer ${token}`;
        document.getElementById("password-container").style.display = "none";
        document.getElementById("main-content").style.display = "flex";
        try {
          await fetchInitialStates();
        } catch (error) {
          deleteCookie("authToken");
          showToast("登录失效，请重新登录");
          location.reload();
        }
      }
    });

    async function verifyPassword() {
      const password = document.getElementById("password").value.trim();
      const errorMessage = document.getElementById("error-message");
      try {
        const response = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password })
        });
        if (response.ok) {
          const { token } = await response.json();
          setCookie("authToken", token, 36500);
          authToken = `Bearer ${token}`;
          document.getElementById("password-container").style.display = "none";
          document.getElementById("main-content").style.display = "flex";
          fetchInitialStates();
        } else {
          errorMessage.textContent = "密码错误，请重新输入。";
          errorMessage.style.display = "block";
        }
      } catch (error) {
        errorMessage.textContent = "服务器连接失败，请稍后重试。";
        errorMessage.style.display = "block";
      }
    }

    async function fetchInitialStates() {
      try {
        const response = await fetch("/states", {
          headers: { Authorization: authToken }
        });
        if (response.status === 401) {
          deleteCookie("authToken");
          showToast("登录已过期，请重新登录");
          location.reload();
          return;
        }
        if (!response.ok) {
          showToast("无法加载数据，请检查权限。");
          return;
        }
        const data = await response.json();
        const container = document.getElementById("main-content");
        container.innerHTML = "";

        // 开关部分：每个开关与对应文字放入独立盒子，每行两个
        const switchBox = document.createElement("div");
        switchBox.classList.add("switch-box");
        const buttonNames = [
          "推送总开关",
          "开关门:推送",
          "挂起，休眠，启动:推送",
          "上线，离线，行驶:推送",
          "行驶中推送",
          "车内有人推送",
          "充电中推送",
          "胎压报警推送",
          "哨兵开关推送",
          "行程结算显示地址"
        ];
        buttonNames.forEach((name, index) => {
          const item = document.createElement("div");
          item.classList.add("switch-item");
          item.innerHTML = `
            <div class="label">${name}</div>
            <div class="toggle-switch ${data.buttons[index] === "ON" ? "on" : "off"}" onclick="toggleSwitch(this, ${index})"></div>
          `;
          switchBox.appendChild(item);
        });
        container.appendChild(switchBox);

        // -------------------------------
        // 新建一个盒子(trajectoryContainer)同时包含行驶轨迹回放按钮与时间选择
        // -------------------------------
        const trajectoryContainer = document.createElement("div");
        trajectoryContainer.style.display = "flex";
        trajectoryContainer.style.flexDirection = "column";
        trajectoryContainer.style.alignItems = "center";
        trajectoryContainer.style.gap = "10px";
        trajectoryContainer.style.marginTop = "10px";
        trajectoryContainer.style.padding = "15px";
        trajectoryContainer.style.boxSizing = "border-box";
        trajectoryContainer.style.borderRadius = "10px";
        trajectoryContainer.style.background = "rgba(255,255,255,0.6)";

        // 新增时间选择区域盒子
        const timeContainer = document.createElement("div");
        timeContainer.style.display = "flex";
        timeContainer.style.flexDirection = "column";
        timeContainer.style.alignItems = "center";
        timeContainer.style.gap = "10px";
        timeContainer.style.marginTop = "10px";
        timeContainer.innerHTML = `
          <div style="display: flex; gap: 10px; align-items: center;">
            <label for="start-time">轨迹开始时间:</label>
            <input type="datetime-local" id="start-time">
          </div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <label for="end-time">轨迹结束时间:</label>
            <input type="datetime-local" id="end-time">
          </div>
        `;
        container.appendChild(trajectoryContainer);
        trajectoryContainer.appendChild(timeContainer);
        
        // 行驶轨迹回放按钮
        const playbackBtn = document.createElement("button");
        playbackBtn.textContent = "行驶轨迹回放";
        playbackBtn.onclick = () => customAction(4);
        playbackBtn.style.padding = "8px";
        playbackBtn.style.fontSize = "0.8rem";
        playbackBtn.style.backgroundColor = "#007aff";
        playbackBtn.style.color = "white";
        playbackBtn.style.border = "1px solid #ccc";
        playbackBtn.style.borderRadius = "10px";
        playbackBtn.style.cursor = "pointer";
        trajectoryContainer.appendChild(playbackBtn);
    
        // 设置时间选择默认值和更改事件绑定
        const now = new Date(new Date().getTime() + 8 * 60 * 60 * 1000);
        const endTimeDefault = now.toISOString().slice(0, 16);
        const startTimeDefault = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString().slice(0, 16);
        document.getElementById("end-time").value = endTimeDefault;
        document.getElementById("start-time").value = startTimeDefault;
        document.getElementById("start-time").addEventListener("change", function() {
          const startTime = new Date(this.value);
          const endTime = new Date(startTime.getTime() + 32 * 60 * 60 * 1000);
          document.getElementById("end-time").value = endTime.toISOString().slice(0, 16);
        });


        // -----------------------
        // 推送行程与充电分组
        // -----------------------
        const pushRow = document.createElement("div");
        pushRow.style.display = "flex";
        pushRow.style.justifyContent = "space-between";
        pushRow.style.gap = "15px";
        pushRow.style.marginTop = "5px";
        pushRow.style.boxSizing = "border-box";

        // 推送行程组
        const pushTripBox = document.createElement("div");
        pushTripBox.style.flex = "1 1 calc((100% - 20px) / 2)";
        pushTripBox.style.boxSizing = "border-box";
        pushTripBox.style.display = "flex";
        pushTripBox.style.flexDirection = "column";
        pushTripBox.style.gap = "5px";
        pushTripBox.style.padding = "10px";
        pushTripBox.style.border = "1px solid #ccc";
        pushTripBox.style.borderRadius = "10px";
        pushTripBox.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
        pushTripBox.style.background = "rgba(255,255,255,0.6)";


        const createSlider = (valueText, defaultValue) => {
          const valueDisplay = document.createElement("div");
          valueDisplay.className = "valueDisplay";
          valueDisplay.textContent = `${valueText}: ${defaultValue}`;
          valueDisplay.style.width = "100%";
          valueDisplay.style.textAlign = "center";
          valueDisplay.style.boxSizing = "border-box";

          const slider = document.createElement("input");
          slider.type = "range";
          slider.min = "1";
          slider.max = "50";
          slider.value = defaultValue;
          slider.style.width = "100%";
          slider.style.boxSizing = "border-box";

          return { valueDisplay, slider };
        };

        const { valueDisplay: tripDisplay, slider: tripSlider } = createSlider("行程统计条数", data.num1);
        tripSlider.addEventListener("input", async () => {
          tripDisplay.textContent = `行程统计条数: ${tripSlider.value}`;
          await updateValueToServer("NUM1", tripSlider.value);
        });

        const pushTripButton = document.createElement("button");
        pushTripButton.textContent = "推送行程统计";
        pushTripButton.onclick = () => customAction(1);
        pushTripButton.style.background = "#007aff";
        pushTripButton.style.color = "#fff";
        pushTripButton.style.fontSize = "0.8rem";
        pushTripButton.style.border = "1px solid #ccc";
        pushTripButton.style.gap = "5px";
        pushTripButton.style.padding = "6.4px 2px";
        pushTripButton.style.borderRadius = "10px";
        pushTripButton.style.cursor = "pointer";
        pushTripButton.style.boxSizing = "border-box";
        pushTripBox.appendChild(tripDisplay);
        pushTripBox.appendChild(tripSlider);
        pushTripBox.appendChild(pushTripButton);

        // 推送充电组
        const pushChargeBox = document.createElement("div");
        pushChargeBox.style.flex = "1 1 calc((100% - 20px) / 2)";
        pushChargeBox.style.boxSizing = "border-box";
        pushChargeBox.style.display = "flex";
        pushChargeBox.style.flexDirection = "column";
        pushChargeBox.style.gap = "5px";
        pushChargeBox.style.padding = "10px";
        pushChargeBox.style.border = "1px solid #ccc";
        pushChargeBox.style.borderRadius = "10px";
        pushChargeBox.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
        pushChargeBox.style.background = "rgba(255,255,255,0.6)";


        const { valueDisplay: chargeDisplay, slider: chargeSlider } = createSlider("充电统计条数", data.num2);
        chargeSlider.addEventListener("input", async () => {
          chargeDisplay.textContent = `充电统计条数: ${chargeSlider.value}`;
          await updateValueToServer("NUM2", chargeSlider.value);
        });

        const pushChargeButton = document.createElement("button");
        pushChargeButton.textContent = "推送充电统计";
        pushChargeButton.onclick = () => customAction(2);
        pushChargeButton.style.background = "#007aff";
        pushChargeButton.style.color = "#fff";
        pushChargeButton.style.fontSize = "0.8rem";
        pushChargeButton.style.border = "1px solid #ccc";
        pushChargeButton.style.gap = "5px";
        pushChargeButton.style.padding = "6.4px 2px";
        pushChargeButton.style.borderRadius = "10px";
        pushChargeButton.style.cursor = "pointer";
        pushChargeButton.style.boxSizing = "border-box";
        pushChargeBox.appendChild(chargeDisplay);
        pushChargeBox.appendChild(chargeSlider);
        pushChargeBox.appendChild(pushChargeButton);

        pushRow.appendChild(pushTripBox);
        pushRow.appendChild(pushChargeBox);
        container.appendChild(pushRow);

        
// -----------------------
    // 定时推送设置分组 (包含手动推送)
    // -----------------------
    const scheduleRow = document.createElement("div");
    scheduleRow.style.display = "flex";
    scheduleRow.style.flexWrap = "wrap";
    scheduleRow.style.justifyContent = "space-between";
    scheduleRow.style.gap = "15px";
    scheduleRow.style.marginTop = "5px";
    scheduleRow.style.boxSizing = "border-box";
    scheduleRow.style.width = "100%";

    const dailyBox = document.createElement("div");
    dailyBox.style.flex = "0 0 calc((100% - 15px) / 2)";
    dailyBox.style.boxSizing = "border-box";
    dailyBox.style.display = "flex";
    dailyBox.style.flexDirection = "column";
    dailyBox.style.gap = "5px";
    dailyBox.style.padding = "10px";
    dailyBox.style.border = "1px solid #ccc";
    dailyBox.style.borderRadius = "10px";
    dailyBox.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
    dailyBox.style.background = "rgba(255,255,255,0.6)";
    dailyBox.style.minWidth = "100px";
    dailyBox.style.overflow = "hidden";
    dailyBox.innerHTML = `
      <div style="font-size: 0.8rem; text-align: center; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">每天推送日报</div>
      <div style="display: flex; gap: 5px;">
        <input type="time" id="daily-time-select" style="flex: 1; padding: 6.4px; border: 1px solid #ccc; border-radius: 5px; min-width: 0;" value="${data.schedule?.daily?.time || '08:00'}">
      </div>
      <div class="toggle-switch ${data.buttons[10] === "ON" ? "on" : "off"}" id="daily-switch" style="margin: 5px auto;" onclick="toggleSwitch(this, 10)"></div>
    `;
    dailyBox.querySelector('#daily-time-select').addEventListener('change', function() {
      updateScheduleTime('daily', this.value);
    });

    const scheduleBox = document.createElement("div");
    scheduleBox.style.flex = "0 0 calc((100% - 15px) / 2)";
    scheduleBox.style.boxSizing = "border-box";
    scheduleBox.style.display = "flex";
    scheduleBox.style.flexDirection = "column";
    scheduleBox.style.gap = "5px";
    scheduleBox.style.padding = "10px";
    scheduleBox.style.border = "1px solid #ccc";
    scheduleBox.style.borderRadius = "10px";
    scheduleBox.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
    scheduleBox.style.background = "rgba(255,255,255,0.6)";
    scheduleBox.style.minWidth = "100px";
    scheduleBox.style.overflow = "hidden";
    scheduleBox.innerHTML = `
      <div style="font-size: 0.8rem; text-align: center; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">每周推送周报</div>
      <div style="display: flex; gap: 5px;">
        <select id="weekday-select" style="flex: 1; padding: 6.4px; border: 1px solid #ccc; border-radius: 5px; min-width: 0;">
          <option value="1" ${data.schedule?.weekly?.weekday === "1" ? "selected" : ""}>星期一</option>
          <option value="2" ${data.schedule?.weekly?.weekday === "2" ? "selected" : ""}>星期二</option>
          <option value="3" ${data.schedule?.weekly?.weekday === "3" ? "selected" : ""}>星期三</option>
          <option value="4" ${data.schedule?.weekly?.weekday === "4" ? "selected" : ""}>星期四</option>
          <option value="5" ${data.schedule?.weekly?.weekday === "5" ? "selected" : ""}>星期五</option>
          <option value="6" ${data.schedule?.weekly?.weekday === "6" ? "selected" : ""}>星期六</option>
          <option value="0" ${data.schedule?.weekly?.weekday === "0" ? "selected" : ""}>星期日</option>
        </select>
        <input type="time" id="time-select" style="flex: 1; padding: 6.4px; border: 1px solid #ccc; border-radius: 5px; min-width: 0;" value="${data.schedule?.weekly?.time || '08:00'}">
      </div>
      <div class="toggle-switch ${data.buttons[11] === "ON" ? "on" : "off"}" id="schedule-switch" style="margin: 5px auto;" onclick="toggleSwitch(this, 11)"></div>
    `;
    scheduleBox.querySelector('#weekday-select').addEventListener('change', function() {
      const time = scheduleBox.querySelector('#time-select').value;
      updateScheduleTime('weekly', { weekday: this.value, time });
    });
    scheduleBox.querySelector('#time-select').addEventListener('change', function() {
      const weekday = scheduleBox.querySelector('#weekday-select').value;
      updateScheduleTime('weekly', { weekday, time: this.value });
    });

    const dateSwitchBox = document.createElement("div");
    dateSwitchBox.style.flex = "0 0 calc((100% - 15px) / 2)";
    dateSwitchBox.style.boxSizing = "border-box";
    dateSwitchBox.style.display = "flex";
    dateSwitchBox.style.flexDirection = "column";
    dateSwitchBox.style.gap = "5px";
    dateSwitchBox.style.padding = "10px";
    dateSwitchBox.style.border = "1px solid #ccc";
    dateSwitchBox.style.borderRadius = "10px";
    dateSwitchBox.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
    dateSwitchBox.style.background = "rgba(255,255,255,0.6)";
    dateSwitchBox.style.minWidth = "100px";
    dateSwitchBox.style.overflow = "hidden";
    dateSwitchBox.innerHTML = `
      <div style="font-size: 0.8rem; text-align: center; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">每月推送月报</div>
      <div style="display: flex; gap: 5px;">
        <select id="date-select" style="flex: 1; padding: 6.4px; border: 1px solid #ccc; border-radius: 5px; min-width: 0;">
          ${Array.from({length: 31}, (_, i) => `<option value="${i + 1}" ${data.schedule?.monthly?.date === String(i + 1) ? "selected" : ""}>${i + 1}号</option>`).join('')}
        </select>
        <input type="time" id="date-time-select" style="flex: 1; padding: 6.4px; border: 1px solid #ccc; border-radius: 5px; min-width: 0;" value="${data.schedule?.monthly?.time || '08:00'}">
      </div>
      <div class="toggle-switch ${data.buttons[12] === "ON" ? "on" : "off"}" id="date-switch" style="margin: 5px auto;" onclick="toggleSwitch(this, 12)"></div>
    `;
    dateSwitchBox.querySelector('#date-select').addEventListener('change', function() {
      const time = dateSwitchBox.querySelector('#date-time-select').value;
      updateScheduleTime('monthly', { date: this.value, time });
    });
    dateSwitchBox.querySelector('#date-time-select').addEventListener('change', function() {
      const date = dateSwitchBox.querySelector('#date-select').value;
      updateScheduleTime('monthly', { date, time: this.value });
    });

    const manualPushBox = document.createElement("div");
    manualPushBox.style.flex = "0 0 calc((100% - 15px) / 2)";
    manualPushBox.style.boxSizing = "border-box";
    manualPushBox.style.display = "flex";
    manualPushBox.style.flexDirection = "column";
    manualPushBox.style.gap = "5px";
    manualPushBox.style.padding = "10px";
    manualPushBox.style.border = "1px solid #ccc";
    manualPushBox.style.borderRadius = "10px";
    manualPushBox.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
    manualPushBox.style.background = "rgba(255,255,255,0.6)";
    manualPushBox.style.minWidth = "100px";
    manualPushBox.style.overflow = "hidden";
    manualPushBox.innerHTML = `
      <button style="width:100%; padding:6.4px 9.6px; font-size:0.8rem; background-color:#007aff; color:#fff; border:1px solid #ccc; border-radius:5px; cursor:pointer;" onclick="customAction(5)">推送日统计</button>
      <button style="width:100%; padding:6.4px 9.6px; font-size:0.8rem; background-color:#007aff; color:#fff; border:1px solid #ccc; border-radius:5px; cursor:pointer;" onclick="customAction(6)">推送周统计</button>
      <button style="width:100%; padding:6.4px 9.6px; font-size:0.8rem; background-color:#007aff; color:#fff; border:1px solid #ccc; border-radius:5px; cursor:pointer;" onclick="customAction(7)">推送月统计</button>
    `;

    scheduleRow.appendChild(dailyBox);
    scheduleRow.appendChild(scheduleBox);
    scheduleRow.appendChild(dateSwitchBox);
    scheduleRow.appendChild(manualPushBox);
    container.appendChild(scheduleRow);



// 通用函数：更新时间选择到后端
async function updateScheduleTime(type, value) {
  let payload;
  switch (type) {
    case 'daily':
      payload = { type: 'daily', time: value };
      break;
    case 'weekly':
      payload = { type: 'weekly', weekday: value.weekday, time: value.time };
      break;
    case 'monthly':
      payload = { type: 'monthly', date: value.date, time: value.time };
      break;
    default:
      console.error('Unknown schedule type:', type);
      return;
  }

  try {
    const response = await fetch('/schedule', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: authToken
      },
      body: JSON.stringify(payload)
    });

    if (response.ok) {
      showToast('时间更新成功');
    } else {
      const errorData = await response.json();
      showToast(`时间更新失败：${errorData.message}`);
    }
  } catch (error) {
    console.error('Error updating schedule time:', error);
    showToast('无法连接服务器，请稍后重试');
  }
}


        
// ---------------------------------------
// 额外配置项（3个盒子，每行2个）
// ---------------------------------------
const extraNames = [
  "胎压报警推送次数",
  "定时推送状态(分钟)",
  "充电定时推送(分钟)"
];
const extraContainer = document.createElement("div");
extraContainer.style.display = "flex";
extraContainer.style.flexWrap = "wrap";
extraContainer.style.gap = "15px";
extraContainer.style.marginTop = "5px";
extraContainer.style.boxSizing = "border-box";
extraContainer.style.width = "100%"; // 确保容器占满宽度

extraNames.forEach((name, num) => {
  const extraBox = document.createElement("div");
  extraBox.style.flex = "0 0 calc((100% - 15px) / 2)"; // 固定一半宽度，不允许伸缩
  extraBox.style.boxSizing = "border-box";
  extraBox.style.fontSize = "0.8rem";
  extraBox.style.overflowWrap = "break-word";
  extraBox.style.display = "flex";
  extraBox.style.flexDirection = "column";
  extraBox.style.gap = "5px";
  extraBox.style.padding = "10px";
  extraBox.style.border = "1px solid #ccc";
  extraBox.style.borderRadius = "10px";
  extraBox.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
  extraBox.style.background = "rgba(255,255,255,0.6)";
  extraBox.style.minWidth = "100px"; // 设置最小宽度以避免过窄
  extraBox.style.overflow = "hidden"; // 处理内容溢出
  extraBox.innerHTML = `
    <label class="material-checkbox" style="font-size:0.8rem; white-space: normal; margin-top:3px;">
      <input type="checkbox" id="extra-checkbox-${num + 1}" ${data.extras["EXTRA_CHECKBOX_" + (num + 1)] === "ON" ? "checked" : ""} onchange="toggleInputState(${num + 1})">
      <span class="checkmark"></span>
      ${name}
    </label>
    <input type="text" id="extra-input-${num + 1}" value="${data.extras["EXTRA_INPUT_" + (num + 1)]}" ${data.extras["EXTRA_CHECKBOX_" + (num + 1)] === "ON" ? "" : "disabled"} style="width: 90%; padding:6.4px; border:1px solid #ccc; border-radius:5px; display:block; margin:0 auto; margin-top:2px;" />
    <button class="button ${data.extras["EXTRA_CHECKBOX_" + (num + 1)] === "ON" ? "" : "disabled"}" id="submit-btn-${num + 1}" onclick="submitExtraData(${num + 1})" style="width:100%; padding:6.4px 2px; font-size:0.8rem; background-color:#007aff; color:#fff; border:1px solid #ccc; border-radius:5px; cursor:pointer; margin-top:10px;">提交</button>
  `;
  extraContainer.appendChild(extraBox);
});
container.appendChild(extraContainer);

  
        // 退出登录按钮
        const logoutButton = document.createElement("button");
        logoutButton.textContent = "退出登录";
        logoutButton.onclick = logout;
        Object.assign(logoutButton.style, {
          position: "absolute",
          bottom: "10px",
          right: "10px",
          padding: "8px 15px",
          background: "#ff4444",
          color: "white",
          border: "none",
          borderRadius: "5px",
          cursor: "pointer",
          zIndex: "9999"
        });
        container.appendChild(logoutButton);
        container.appendChild(document.createElement("br"));
      } catch (error) {
        console.error("Error:", error);
        showToast("无法连接服务器，请检查网络。");
      }
    }

    async function customAction(actionId) {
      if (actionId === 4) {
        const startTime = document.getElementById("start-time").value;
        const endTime = document.getElementById("end-time").value;
        if (!startTime || !endTime) {
          showToast("请选择开始和结束时间");
          return;
        }
        const start = new Date(startTime);
        const end = new Date(endTime);
        if (end - start > 168 * 60 * 60 * 1000) {
          showToast("时间间隔不能超过7天");
          return;
        }
        const newWindow = window.open("", "_blank");
        try {
          const response = await fetch("/path", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: authToken
            },
            body: JSON.stringify({ startTime, endTime })
          });
          if (!response.ok) {
            const data = await response.json();
            showToast(`获取路径失败：${data.message}`);
            newWindow.close();
            return;
          }
          const data = await response.json();
          openCarRoutePage(newWindow, data.path);
        } catch (error) {
          showToast("无法获取路径数据，请稍后重试。");
          newWindow.close();
          console.error("Error:", error);
        }
        return;
      }
      try {
        const response = await fetch(`/custom-action-${actionId}`, {
          method: "POST",
          headers: {
            Authorization: authToken,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ actionId })
        });
        if (response.ok) {
          const data = await response.json();
          showToast(data.message);
        } else {
          const errorData = await response.json();
          showToast(`操作失败：${errorData.message}`);
        }
      } catch (error) {
        showToast("无法完成操作，请稍后重试。");
        console.error("Error:", error);
      }
    }

    function openCarRoutePage(newWin, pathData) {
      const pathJson = JSON.stringify(pathData);

      const htmlContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>轨迹回放</title>
  <style type="text/css">
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #container {
      position: relative;
      width: 100%;
      height: 100%;
      z-index: 0;
    }
    #distance {
      position: absolute;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 20px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      z-index: 9999;
      width: 280px;
      text-align: left;
    }
    #timestamp {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 20px;
      white-space: nowrap;
      z-index: 9999;
      width: 280px;
      text-align: center;
    }
    #player-controls {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      align-items: center;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 8px;
    }
    #pauseResumeBtn, #replayBtn, #speedDecreaseBtn, #speedIncreaseBtn {
      flex: 1;
      font-size: 16px;
      padding: 10px;
      border: 2px solid transparent;
      border-radius: 5px;
      cursor: pointer;
      background-color: #fff;
      color: #333;
      text-align: center;
      box-shadow: 0 0 5px rgba(144, 238, 144, 0.7), 0 0 10px rgba(144, 238, 144, 0.5);
      transition: box-shadow 0.3s ease, border-color 0.3s ease;
    }
    #progressSlider {
      width: 200px;
    }
  </style>
  <!-- 请将下面的 key 替换成您自己的腾讯地图 key -->
  <script charset="utf-8" src="https://map.qq.com/api/gljs?v=1.exp&key=U66BZ-ABVWT-CSVXW-VDD7W-RDLQH-6UF66"><\/script>
  <script charset="utf-8" src="https://map.qq.com/api/gljs?v=1.exp&key=U66BZ-ABVWT-CSVXW-VDD7W-RDLQH-6UF66&libraries=geometry"><\/script>
</head>
<body>
  <div id="container"></div>
  <div id="distance"></div>
  <div id="timestamp"></div>
  <div id="player-controls">
    <button id="speedDecreaseBtn">减慢</button>
    <button id="pauseResumeBtn">暂停</button>
    <button id="speedIncreaseBtn">加快</button>
    <input type="range" id="progressSlider" value="0" min="0" style="width: 200px;" />
  </div>
  <script type="text/javascript">
    // =========================================================
    // 全局变量: 用于记录距离不清零、控制暂停、速度
    // =========================================================
    let accumulatedDistance = 0;       // 累加之前已走的路程
    let currentDistanceSegment = 0;    // 当前段(本次播放过程)实时行驶距离

    // pathData 注入
    const rawPath = ${pathJson};
    if (!rawPath || rawPath.length === 0) {
      document.body.innerHTML = '<h2>暂无路径数据</h2>';
      throw new Error('No path data provided.');
    }
    const path = rawPath.map(pt => new TMap.LatLng(pt.lat, pt.lng));

    const first = path[0];
    const last = path[path.length - 1];
    const center = new TMap.LatLng(
      (first.getLat() + last.getLat()) / 2, 
      (first.getLng() + last.getLng()) / 2
    );

    const map = new TMap.Map('container', { center });
    const bounds = new TMap.LatLngBounds();
    path.forEach(pt => bounds.extend(pt));
    const ne = bounds.getNorthEast(), sw = bounds.getSouthWest();

    // 视野扩大一部分
    const extraLat = (ne.getLat() - sw.getLat()) * 0.05;
    const extraLng = (ne.getLng() - sw.getLng()) * 0.05;
    const newNe = new TMap.LatLng(ne.getLat() + extraLat, ne.getLng() + extraLng);
    const newSw = new TMap.LatLng(sw.getLat() - extraLat, sw.getLng() - extraLng);
    const expandedBounds = new TMap.LatLngBounds(newSw, newNe);
    map.fitBounds(expandedBounds);

    // 多段线图层
    const polylineLayer = new TMap.MultiPolyline({
      map,
      styles: {
        style_blue: new TMap.PolylineStyle({
          color: '#3777FF',
          width: 4,
          borderWidth: 2,
          borderColor: '#FFF',
          lineCap: 'round',
          eraseColor: 'rgba(190,188,188,1)',
          showArrow: true,
          arrowOptions: { width: 8, height: 5, space: 30, animSpeed: 50 }
        }),
        style_gray: new TMap.PolylineStyle({
          color: '#bebcbc',
          width: 3,
          borderWidth: 1,
          borderColor: '#FFF',
          lineCap: 'round',
          eraseColor: 'rgba(190,188,188,1)',
          showArrow: true,
          arrowOptions: { width: 8, height: 5, space: 30, animSpeed: 50 }
        })
      },
      geometries: [
        {
          id: 'erasePath',
          styleId: 'style_blue',
          paths: path
        }
      ]
    });

    // 标记图层
    const marker = new TMap.MultiMarker({
      map,
      styles: {
        'car-down': new TMap.MarkerStyle({
          width: 40, 
          height: 40,
          anchor: { x: 20, y: 20 },
          faceTo: 'map',
          rotate: 180,
          src: 'https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/car.png'
        }),
        start: new TMap.MarkerStyle({
          width: 25, 
          height: 35,
          anchor: { x: 16, y: 32 },
          src: 'https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/start.png'
        }),
        end: new TMap.MarkerStyle({
          width: 25, 
          height: 35,
          anchor: { x: 16, y: 32 },
          src: 'https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/end.png'
        })
      },
      geometries: [
        { id: 'car', styleId: 'car-down', position: path[0] },
        { id: 'start', styleId: 'start', position: path[0] },
        { id: 'end', styleId: 'end', position: path[path.length - 1] }
      ]
    });

    // 其他控制变量
    let totalSegments = path.length - 1;
    let autoSpeed = 1000;
    let currentIndex = 0;
    let globalOffset = 0;
    let isPaused = false;
    let eraseFlag = 0;

    // 初始化回放
    function startPlayback() {
      currentIndex = 0;
      marker.moveAlong(
        { car: { path, speed: autoSpeed } },
        { autoRotation: true }
      );
    }

    // 切换暂停/继续
    function togglePauseResume() {
      if (!isPaused) {
        marker.pauseMove();
        isPaused = true;
        document.getElementById('pauseResumeBtn').textContent = '继续';
      } else {
        marker.resumeMove();
        isPaused = false;
        document.getElementById('pauseResumeBtn').textContent = '暂停';
      }
    }

    // 设置进度条数值
    function setSliderValue(idx) {
      const slider = document.getElementById('progressSlider');
      slider.max = totalSegments;
      slider.value = idx + globalOffset;
    }

    // 更新时间戳显示
    function updateTimestampDisplay(idx) {
      const timestampElem = document.getElementById("timestamp");
      timestampElem.textContent = rawPath[idx + globalOffset]?.timestamp || '';
    }

    // 开始播放
    startPlayback();

    // 监听移动事件，实时更新距离
    marker.on('moving', function(e) {
      const passedLatLngs = e.car?.passedLatLngs;
      if (passedLatLngs && passedLatLngs.length > 0) {
        currentIndex = passedLatLngs.length - 1;
        setSliderValue(currentIndex);

        // 当前段距离
        currentDistanceSegment = TMap.geometry.computeDistance(passedLatLngs);

        // 显示 = 累计距离 + 当前段距离
        document.getElementById('distance').innerHTML =
          '当前行驶距离：' + Math.round(accumulatedDistance + currentDistanceSegment) + '米';

        // 擦除操作
        if (eraseFlag === 1) {
          polylineLayer.eraseTo(
            'erasePath',
            currentIndex + globalOffset,
            path[currentIndex + globalOffset]
          );
          eraseFlag = 0;
        }
        polylineLayer.eraseTo(
          'erasePath',
          passedLatLngs.length - 1,
          passedLatLngs[passedLatLngs.length - 1]
        );

        updateTimestampDisplay(currentIndex);
      }
    });

    // 拖动条事件
    const progressSlider = document.getElementById('progressSlider');

    // 拖动中（input事件）: 暂停播放，更新小车位置，并实时显示「起点到拖动点」距离
    progressSlider.addEventListener('input', function() {
      const idx = parseInt(this.value, 10);
      marker.pauseMove();
      isPaused = true;
      document.getElementById('pauseResumeBtn').textContent = '继续';

      // 小车位置同步
      if (path[idx]) {
        marker.updateGeometries([{ id: 'car-down', position: path[idx] }]);
      }
      updateTimestampDisplay(idx);

      // 拖动中计算并显示“从起点到拖动点”的距离
      const partialPaths = path.slice(0, idx + 1);
const dragDistance = partialPaths.length < 2 ? 0 : TMap.geometry.computeDistance(partialPaths);
      document.getElementById('distance').innerHTML =
        '当前行驶距离：' + Math.round(dragDistance) + '米';
    });

    // 拖动结束（change事件）: 恢复/重新播放
    progressSlider.addEventListener('change', function() {
      const idx = parseInt(this.value, 10);

      marker.stopMove();
      globalOffset = idx;

      // 拖动后，先计算拖动到 idx 的路径距离加到 accumulatedDistance
      // （如果希望仅从真正走过的地方开始记录，可以视情况处理。
      //  如需“跳过”没走过的部分，可把 accumulatedDistance 改成 0 或别的逻辑）
      const slicedPath = path.slice(0, idx + 1);
accumulatedDistance = slicedPath.length < 2 ? 0 : TMap.geometry.computeDistance(slicedPath);
      currentDistanceSegment = 0;

      // 播放剩余路径
      const subPath = path.slice(idx);
      const passedPath = path.slice(0, idx + 1);
      if (!subPath.length) return;

      eraseFlag = 1; 
      marker.moveAlong(
        { car: { path: subPath, speed: autoSpeed } },
        { autoRotation: true }
      );

      polylineLayer.updateGeometries([
        { id: 'passedPath', styleId: 'style_gray', paths: passedPath }
      ]);
      polylineLayer.updateGeometries([
        { id: 'erasePath', styleId: 'style_blue', paths: subPath }
      ]);
      polylineLayer.eraseTo('erasePath', idx, path[idx]);

      isPaused = false;
      document.getElementById('pauseResumeBtn').textContent = '暂停';
      // 改变后先赋值一次
      document.getElementById('distance').innerHTML =
        '当前行驶距离：' + Math.round(accumulatedDistance) + '米';
    });

    // 提示
    function showToast(message) {
      const toast = document.createElement("div");
      toast.textContent = message;
      toast.style.position = 'fixed';
      toast.style.bottom = '100px';
      toast.style.left = '50%';
      toast.style.transform = 'translateX(-50%)';
      toast.style.background = 'rgba(0, 0, 0, 0.7)';
      toast.style.color = '#fff';
      toast.style.padding = '10px 20px';
      toast.style.borderRadius = '5px';
      toast.style.zIndex = '10000';
      document.body.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 2000);
    }

    // 更新速度: 变速前先把当前段距离累加到 accumulatedDistance
    function updateSpeed(newSpeed) {
      // 把当前段距离加到累计里
      accumulatedDistance += currentDistanceSegment;
      // 重置本段距离
      currentDistanceSegment = 0;

      showToast("当前速度: " + newSpeed);
      autoSpeed = newSpeed;
      marker.stopMove();

      const idx = parseInt(document.getElementById('progressSlider').value, 10);
      globalOffset = idx;

      const subPath = path.slice(idx);
      if (!subPath.length) return;

      marker.moveAlong(
        { car: { path: subPath, speed: autoSpeed } },
        { autoRotation: true }
      );
      isPaused = false;
      document.getElementById('pauseResumeBtn').textContent = '暂停';

      // 显示一下当前累计距离
      document.getElementById('distance').innerHTML =
        '当前行驶距离：' + Math.round(accumulatedDistance) + '米';
    }

    // 按钮事件
    document.getElementById('pauseResumeBtn').addEventListener('click', togglePauseResume);

    document.getElementById('speedDecreaseBtn').addEventListener('click', function() {
      let newSpeed = autoSpeed - 200;
      if (newSpeed < 0) newSpeed = 0;
      updateSpeed(newSpeed);
    });

    document.getElementById('speedIncreaseBtn').addEventListener('click', function() {
      let newSpeed = autoSpeed + 200;
      updateSpeed(newSpeed);
    });
  <\/script>
</body>
</html>
      `;

      // 将上面生成的 html 写入新窗口
      newWin.document.open();
      newWin.document.write(htmlContent);
      newWin.document.close();
    }

    function toggleSwitch(element, index) {
      const isOn = element.classList.contains("on");
      const newStatus = isOn ? "OFF" : "ON";
      element.classList.toggle("on", !isOn);
      element.classList.toggle("off", isOn);
      fetch("/update", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: authToken
        },
        body: JSON.stringify({ id: index, status: newStatus })
      });
    }

    async function submitExtraData(num) {
      const input = document.getElementById(`extra-input-${num}`).value;
      await fetch("/extra", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: authToken
        },
        body: JSON.stringify({
          id: num,
          checkbox: document.getElementById(`extra-checkbox-${num}`).checked,
          input: input
        })
      });
      showToast("提交成功！");
    }

    async function toggleInputState(num) {
      const checkbox = document.getElementById(`extra-checkbox-${num}`);
      const input = document.getElementById(`extra-input-${num}`);
      const button = document.getElementById(`submit-btn-${num}`);
      const isChecked = checkbox.checked;
      input.disabled = !isChecked;
      button.classList.toggle("disabled", !isChecked);
      try {
        const response = await fetch("/extra", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: authToken
          },
          body: JSON.stringify({
            id: num,
            checkbox: isChecked,
            input: input.value
          })
        });
        if (!response.ok) {
          console.error("Failed to update state:", await response.json());
        }
      } catch (error) {
        console.error("Error updating state:", error);
      }
    }

    async function updateValueToServer(name, value) {
      try {
        const response = await fetch(`/update-slider`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: authToken
          },
          body: JSON.stringify({ name, value })
        });
        if (!response.ok) {
          console.error("Failed to update slider value:", await response.json());
        }
      } catch (error) {
        console.error("Error updating slider value:", error);
      }
    }
  </script>
</body>
</html>